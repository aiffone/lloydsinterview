steps:
  # Step 1: Build the Docker image
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/hello-world:latest', '.']

  # Step 2: Push the Docker image to Google Container Registry (GCR)
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/hello-world:latest']

  # Step 3: Authenticate to GKE cluster and install gke-gcloud-auth-plugin
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if ! gcloud components install gke-gcloud-auth-plugin -q; then
          echo "Failed to install gke-gcloud-auth-plugin"
          exit 1
        fi
        gcloud container clusters get-credentials infra1-gke-cluster --zone us-central1 --project $PROJECT_ID


  # Step 5: Deploy the application to GKE using Helm
  - name: 'alpine/helm'
    args:
      - 'upgrade'
      - '--install'
      - 'hello-world'
      - './helm-chart'
      - '--set'
      - 'image.repository=gcr.io/$PROJECT_ID/hello-world'
      - '--set'
      - 'image.tag=latest'

images:
  - 'gcr.io/$PROJECT_ID/hello-world:latest'

options:
  logging: CLOUD_LOGGING_ONLY
timeout: '1200s'
