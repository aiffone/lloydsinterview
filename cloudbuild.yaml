steps:
  # Step 1: Build the Docker image from the Dockerfile in the root directory.
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/hello-world:latest', '.']

  # Step 2: Push the Docker image to Google Container Registry (GCR).
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/hello-world:latest']

  # Step 3: Set up GKE authentication for the region.
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        echo "Authenticating with GKE in the region..."
        gcloud container clusters get-credentials infra1-gke-cluster --region europe-west1 --project $PROJECT_ID

  # Step 4: Deploy the image to GKE using Helm.
  - name: 'alpine/helm'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        echo "Deploying to GKE with Helm..."
        helm upgrade --install hello-world ./helm-chart \
        --set image.repository=gcr.io/$PROJECT_ID/hello-world \
        --set image.tag=latest
    env:
      - 'CLOUDSDK_COMPUTE_REGION=europe-west1'
      - 'CLOUDSDK_CONTAINER_CLUSTER=infra1-gke-cluster'

# Optional: Set the service account if necessary for specific permissions.
serviceAccount: "jenkins@infra1-430721.iam.gserviceaccount.com"

# Specify logs bucket for Cloud Build logs.
logsBucket: "gs://cloudbuild-logs-01101"  # Replace with your actual bucket name.
